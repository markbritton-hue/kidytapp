<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Viddy" />
  <meta name="theme-color" content="#030712" />
  <title>Viddy — Watch</title>
  <link rel="icon" href="public/favicon.svg" type="image/svg+xml" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Landscape on phones: fill the screen with video, keep top bar */
    @media (orientation: landscape) and (max-height: 500px) {
      body { height: 100dvh; min-height: unset; overflow: hidden; }
      #top-bar { padding-top: 0.25rem; padding-bottom: 0.25rem; }
      #video-outer { padding: 0; min-height: 0; }
      #video-wrap { height: 100%; align-self: stretch; max-width: 100%; }
      #video-aspect { padding-bottom: 0 !important; height: 100%; }
      #player { position: static; width: 100%; height: 100%; border-radius: 0.5rem; }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-950 flex flex-col">

  <!-- Top bar -->
  <div id="top-bar" class="flex items-center gap-3 px-4 py-3 bg-gray-900/80 backdrop-blur-sm">
    <a id="back-btn" href="index.html" class="inline-flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-full transition-all text-sm">
      ← Back
    </a>
    <span class="text-gray-400 text-sm">Viddy</span>
  </div>

  <!-- Video player -->
  <div id="video-outer" class="flex-1 flex items-center justify-center p-2 sm:p-6">
    <div id="video-wrap" class="w-full max-w-5xl">
      <div id="video-aspect" class="relative w-full" style="padding-bottom: 56.25%;">
        <iframe
          id="player"
          class="absolute inset-0 w-full h-full rounded-xl shadow-2xl"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(location.search);
    const videoId    = params.get("v");
    const from       = params.get("from");
    const uid        = params.get("uid");
    const videoTitle = params.get("title") || videoId;
    const channelName = params.get("ch") || "";

    // Validate video ID (11 chars alphanumeric + - _)
    if (!videoId || !/^[\w-]{11}$/.test(videoId)) {
      location.href = "index.html";
    }

    // Set back button
    if (from) {
      document.getElementById("back-btn").href = `channel.html?id=${from}${uid ? "&uid=" + uid : ""}`;
    }

    // Set iframe src
    document.getElementById("player").src =
      `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&playsinline=1&autoplay=1`;

    // ── Watch tracking ────────────────────────────────────────────────────────
    if (uid) {
      const sessionId  = Date.now().toString();
      const sessionRef = doc(db, "users", uid, "watchHistory", sessionId);
      const startTime  = Date.now();

      const nowPlayingRef = doc(db, "users", uid, "status", "nowPlaying");
      const videoData = {
        videoId,
        videoTitle,
        channelId:    from || "",
        channelName,
        thumbnail:    `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`,
        startedAt:    new Date().toISOString(),
        durationSeconds: 0,
      };

      // Write initial record
      setDoc(sessionRef, videoData).catch(err => console.error("[Viddy] watchHistory write failed:", err));

      // Write live now-playing status
      setDoc(nowPlayingRef, videoData).catch(err => console.error("[Viddy] nowPlaying write failed:", err));

      // Update duration in Firestore
      function saveDuration() {
        const secs = Math.floor((Date.now() - startTime) / 1000);
        if (secs < 2) return;
        const update = { durationSeconds: secs, endedAt: new Date().toISOString() };
        updateDoc(sessionRef, update).catch(() => {});
        updateDoc(nowPlayingRef, { durationSeconds: secs }).catch(() => {});
      }

      // Clear now-playing status when leaving
      function clearNowPlaying() {
        deleteDoc(nowPlayingRef).catch(() => {});
      }

      // Save every 30 seconds
      setInterval(saveDuration, 30000);

      // Save when navigating away
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) { saveDuration(); clearNowPlaying(); }
      });
      window.addEventListener("pagehide", () => { saveDuration(); clearNowPlaying(); });
    }
  </script>
</body>
</html>
