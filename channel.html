<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KidyTapp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .video-card { transition: transform 0.18s, box-shadow 0.18s; }
    .video-card:hover { transform: scale(1.03); box-shadow: 0 16px 32px rgba(0,0,0,0.2); }
    .video-card:active { transform: scale(0.97); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-purple-500 via-blue-500 to-sky-400">

  <!-- Back button -->
  <div class="px-4 pt-6">
    <a href="index.html" class="inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold px-4 py-2 rounded-full transition-all">
      ‚Üê Back
    </a>
  </div>

  <!-- Channel header -->
  <header id="channel-header" class="px-6 py-6 flex items-center gap-4 max-w-5xl mx-auto">
    <div class="w-20 h-20 rounded-full bg-white/20 animate-pulse flex-shrink-0"></div>
    <div>
      <h1 class="text-3xl font-extrabold text-white">Loading‚Ä¶</h1>
      <p id="subtitle" class="text-blue-100 mt-1"></p>
    </div>
  </header>

  <!-- Videos grid -->
  <section class="px-4 sm:px-8 pb-16 max-w-5xl mx-auto">
    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6"></div>
  </section>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(location.search);
    const channelId = params.get("id");
    const uid = params.get("uid");
    if (!channelId || !uid) { location.href = "index.html"; }

    async function load() {
      // Verify channel is approved in Firestore under the active user
      const snap = await getDoc(doc(db, "users", uid, "channels", channelId));
      if (!snap.exists()) { location.href = "index.html"; return; }
      const channel = snap.data();

      // Render channel header
      document.getElementById("channel-header").innerHTML = `
        ${channel.thumbnail
          ? `<img src="${channel.thumbnail}" alt="${channel.name}" class="w-20 h-20 rounded-full object-cover border-4 border-white/50 shadow-lg flex-shrink-0" />`
          : `<div class="w-20 h-20 rounded-full bg-white/30 flex items-center justify-center text-4xl flex-shrink-0">üì∫</div>`}
        <div>
          <h1 class="text-3xl font-extrabold text-white drop-shadow">${channel.name}</h1>
          <p id="subtitle" class="text-blue-100 mt-1">Loading videos‚Ä¶</p>
        </div>`;

      // Fetch videos via YouTube RSS ‚Üí rss2json (no API key needed)
      const rssUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`;
      const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`);
      const data = await res.json();

      if (data.status !== "ok") {
        document.getElementById("grid").innerHTML = `
          <div class="col-span-full bg-red-100 border border-red-300 rounded-2xl p-6 text-center">
            <p class="text-red-700 font-medium">Could not load videos.</p>
            <p class="text-red-500 text-sm mt-1">The channel may not exist or may be unavailable.</p>
          </div>`;
        return;
      }

      const videos = data.items || [];
      document.getElementById("subtitle").textContent =
        videos.length ? `${videos.length} latest videos` : "No videos found";

      if (videos.length === 0) {
        document.getElementById("grid").innerHTML = `
          <div class="col-span-full text-center py-16 text-white/80 text-xl">
            <div class="text-6xl mb-4">üì≠</div>No videos found.
          </div>`;
        return;
      }

      document.getElementById("grid").innerHTML = videos.map(item => {
        // Extract video ID from guid (format: "yt:video:VIDEO_ID")
        const videoId = item.guid.replace("yt:video:", "");
        const title = item.title;
        const thumb = item.thumbnail || `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
        const date = new Date(item.pubDate).toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });

        return `
          <a href="watch.html?v=${videoId}&from=${channelId}&uid=${uid}" class="video-card block bg-white rounded-2xl overflow-hidden shadow-md">
            <div class="relative aspect-video bg-gray-200">
              <img src="${thumb}" alt="${title}" class="w-full h-full object-cover" />
              <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity bg-black/30">
                <div class="bg-red-600 rounded-full p-3 shadow-xl">
                  <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
              </div>
            </div>
            <div class="p-3">
              <p class="font-semibold text-gray-800 text-sm leading-snug" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${title}</p>
              <p class="text-xs text-gray-400 mt-1">${date}</p>
            </div>
          </a>`;
      }).join("");
    }

    load().catch(err => {
      document.getElementById("grid").innerHTML = `
        <div class="col-span-full text-center py-16 text-white/80">
          Error: ${err.message}
        </div>`;
    });
  </script>
</body>
</html>
