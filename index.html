<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Viddy" />
  <meta name="theme-color" content="#38bdf8" />
  <title>Viddy</title>
  <link rel="icon" href="public/favicon.svg" type="image/svg+xml" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .channel-card { transition: transform 0.18s, box-shadow 0.18s; }
    .channel-card:hover  { transform: scale(1.06); box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
    .channel-card:active { transform: scale(0.96); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-400 via-blue-500 to-purple-600 overflow-x-hidden">

  <button id="parent-zone-btn" class="fixed top-4 right-4 z-50 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white text-xs font-medium px-3 py-2 rounded-full border border-white/30 transition-all flex items-center gap-1">
    ðŸ”’ Parent Zone
  </button>

  <!-- First-time setup modal -->
  <div id="setup-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center">
      <div class="text-6xl mb-4">ðŸ‘‹</div>
      <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Welcome to Viddy!</h2>
      <p class="text-gray-500 text-sm mb-6">To get started, a parent needs to set things up first.</p>
      <ol class="text-left space-y-3 mb-7">
        <li class="flex items-start gap-3">
          <span class="flex-shrink-0 w-7 h-7 rounded-full bg-blue-100 text-blue-600 font-bold text-sm flex items-center justify-center">1</span>
          <span class="text-gray-700 text-sm pt-0.5">Tap the <strong>ðŸ”’ Parent Zone</strong> button in the topâ€‘right corner</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="flex-shrink-0 w-7 h-7 rounded-full bg-blue-100 text-blue-600 font-bold text-sm flex items-center justify-center">2</span>
          <span class="text-gray-700 text-sm pt-0.5">Create a new <strong>username and password</strong></span>
        </li>
        <li class="flex items-start gap-3">
          <span class="flex-shrink-0 w-7 h-7 rounded-full bg-blue-100 text-blue-600 font-bold text-sm flex items-center justify-center">3</span>
          <span class="text-gray-700 text-sm pt-0.5">Add the <strong>YouTube channels</strong> you want your child to watch</span>
        </li>
      </ol>
      <button id="setup-dismiss" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl text-base transition-colors">
        Got it!
      </button>
    </div>
  </div>

  <!-- Parent login modal -->
  <div id="parent-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm relative">
      <button id="modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl font-bold leading-none">&times;</button>
      <div class="flex justify-center mb-5">
        <img src="public/logo.svg" alt="Viddy" class="w-12 h-12" />
      </div>
      <div class="text-center mb-5">
        <h2 class="text-xl font-extrabold text-gray-800">Parent Zone</h2>
        <p class="text-gray-500 text-sm mt-1">Sign in to manage Viddy</p>
      </div>
      <form id="modal-form" class="space-y-3">
        <input id="modal-username" type="text" placeholder="Username" autocomplete="username"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:outline-none focus:border-blue-400 transition-colors text-sm" />
        <input id="modal-password" type="password" placeholder="Password" autocomplete="current-password"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-2xl focus:outline-none focus:border-blue-400 transition-colors text-sm" />
        <p id="modal-error" class="hidden text-red-600 text-sm text-center font-medium"></p>
        <button type="submit"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl text-base transition-colors disabled:opacity-50">
          Sign In
        </button>
      </form>
    </div>
  </div>

  <div class="pointer-events-none fixed top-10 left-8 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
  <div class="pointer-events-none fixed top-32 right-16 w-36 h-36 bg-yellow-300/20 rounded-full blur-3xl"></div>
  <div class="pointer-events-none fixed bottom-20 left-1/4 w-28 h-28 bg-pink-300/20 rounded-full blur-2xl"></div>

  <header class="pt-10 pb-6 px-6 text-center">
    <div class="flex items-center justify-center gap-3 mb-2">
      <img src="public/logo.svg" alt="Viddy" class="w-14 h-14 drop-shadow-lg" />
      <h1 class="text-5xl font-extrabold text-white drop-shadow-lg tracking-wide">Viddy</h1>
    </div>
    <p id="subtitle" class="text-blue-100 text-lg font-medium">Loadingâ€¦</p>
  </header>

  <section class="px-4 sm:px-8 pb-16 max-w-6xl mx-auto">
    <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6"></div>
  </section>

  <script type="module">
    import { db, auth, usernameToEmail } from "./js/firebase-config.js";
    import {
      doc, getDoc, collection, getDocs, query, orderBy, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const COLORS = [
      "from-blue-400 to-purple-500",
      "from-pink-400 to-orange-400",
      "from-green-400 to-teal-500",
      "from-yellow-400 to-orange-500",
      "from-purple-400 to-pink-500",
      "from-cyan-400 to-blue-500",
    ];

    function pickColor(id) {
      let h = 0;
      for (let i = 0; i < id.length; i++) h = id.charCodeAt(i) + ((h << 5) - h);
      return COLORS[Math.abs(h) % COLORS.length];
    }

    async function load() {
      const subtitle = document.getElementById("subtitle");
      const grid     = document.getElementById("grid");

      // Get the active user ID from config
      const configSnap = await getDoc(doc(db, "config", "settings"));
      if (!configSnap.exists() || !configSnap.data().parentSetup) {
        document.getElementById("setup-modal").classList.remove("hidden");
        subtitle.textContent = "Setup needed";
        grid.innerHTML = "";
        return;
      }
      if (!configSnap.data().activeUserId) {
        subtitle.textContent = "No channels yet â€” ask a parent to set up Viddy!";
        grid.innerHTML = `
          <div class="col-span-full flex flex-col items-center py-24 gap-6">
            <div class="text-8xl animate-bounce">ðŸ“º</div>
            <p class="text-white/80 text-xl text-center max-w-sm">Ask a parent to set up Viddy first!</p>
          </div>`;
        return;
      }

      const { activeUserId } = configSnap.data();

      // Check bedtime schedule before showing anything
      const schedSnap = await getDoc(doc(db, "users", activeUserId, "status", "schedule")).catch(() => null);
      if (schedSnap && schedSnap.exists()) {
        const s = schedSnap.data();
        let blocked = false;
        if (s.forceStopped) blocked = true;
        else if (s.enabled && s.bedtime) {
          const now = new Date();
          const nowMins = now.getHours() * 60 + now.getMinutes();
          const [h, m] = s.bedtime.split(":").map(Number);
          if (nowMins >= h * 60 + m) blocked = true;
        }
        if (blocked) {
          subtitle.textContent = "See you tomorrow!";
          grid.innerHTML = `
            <div class="col-span-full flex flex-col items-center py-24 gap-4">
              <div class="text-8xl">ðŸŒ™</div>
              <p class="text-white text-2xl font-bold">Time to stop watching!</p>
              <p class="text-blue-100 text-center">${s.forceStopped ? "A parent has stopped watching for now." : "It's bedtime. See you tomorrow!"}</p>
            </div>`;
          return;
        }
      }

      // Load that user's approved channels
      const snap = await getDocs(
        query(collection(db, "users", activeUserId, "channels"), orderBy("addedAt", "asc"))
      );
      const channels = snap.docs.map(d => d.data());

      if (channels.length === 0) {
        subtitle.textContent = "No channels yet â€” add some in the Parent Zone!";
        grid.innerHTML = `
          <div class="col-span-full flex flex-col items-center py-24 gap-6">
            <div class="text-8xl animate-bounce">ðŸ“º</div>
            <p class="text-white/80 text-xl text-center max-w-sm">No channels added yet. Ask a parent to add some!</p>
          </div>`;
        return;
      }

      subtitle.textContent = "Pick a channel to watch!";
      grid.innerHTML = channels.map(ch => `
        <a href="channel.html?id=${ch.id}&uid=${activeUserId}" class="channel-card block">
          <div class="bg-gradient-to-br ${pickColor(ch.id)} rounded-3xl overflow-hidden shadow-lg">
            <div class="aspect-square bg-black/10">
              ${ch.thumbnail
                ? `<img src="${ch.thumbnail}" alt="${ch.name}" class="w-full h-full object-cover" />`
                : `<div class="w-full h-full flex items-center justify-center text-6xl">ðŸ“º</div>`}
            </div>
            <div class="px-3 py-3 bg-white/20 backdrop-blur-sm">
              <p class="text-white font-bold text-sm sm:text-base text-center truncate drop-shadow">${ch.name}</p>
            </div>
          </div>
        </a>`).join("");
    }

    load().catch(() => {
      document.getElementById("subtitle").textContent = "Error loading channels. Check your connection.";
    });

    // â”€â”€ First-time setup modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("setup-dismiss").addEventListener("click", () => {
      document.getElementById("setup-modal").classList.add("hidden");
    });

    // â”€â”€ Parent Zone modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Always sign out any lingering session so login is always required
    signOut(auth).catch(() => {});

    const modal    = document.getElementById("parent-modal");
    const modalErr = document.getElementById("modal-error");

    document.getElementById("parent-zone-btn").addEventListener("click", () => {
      modal.classList.remove("hidden");
      modalErr.classList.add("hidden");
      document.getElementById("modal-username").value = "";
      document.getElementById("modal-password").value = "";
      document.getElementById("modal-username").focus();
    });

    document.getElementById("modal-close").addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    modal.addEventListener("click", e => {
      if (e.target === modal) modal.classList.add("hidden");
    });

    document.getElementById("modal-form").addEventListener("submit", async e => {
      e.preventDefault();
      const username = document.getElementById("modal-username").value.trim();
      const password = document.getElementById("modal-password").value;
      const btn = e.submitter;

      modalErr.classList.add("hidden");
      if (!username || !password) return;

      btn.disabled = true;
      btn.textContent = "Signing inâ€¦";

      try {
        const cred = await signInWithEmailAndPassword(auth, usernameToEmail(username), password);
        await setDoc(doc(db, "config", "settings"), {
          activeUserId: cred.user.uid,
          username,
          parentSetup: true,
        }, { merge: true });
        location.href = "parent/dashboard.html";
      } catch {
        modalErr.textContent = "Incorrect username or password.";
        modalErr.classList.remove("hidden");
        btn.disabled = false;
        btn.textContent = "Sign In";
      }
    });
  </script>
</body>
</html>
